<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>libc welcome example</title>
    <script src="../dist/libc.js"></script>
</head>

<body>
    <div id="app"></div>

    <script>
        (() => {
            let products = [
                { id: 1, title: 'Product #1', description: 'Product number one in our list', quantity: 5, price: 14.87 },
                { id: 2, title: 'Product #2', description: 'Some other product in the store', quantity: 2, price: 0.97 },
                { id: 3, title: 'Product #3', description: 'Coolest product ever!', quantity: 3, price: 99.99 },
                { id: 5, title: 'Product #4', description: 'You wanna buy this!!!111', quantity: 17, price: 273.00 }
            ];

            dispatch({ db: { products, shoppingCart: [] } });
        })();

        createSelector('products', state => state.products);

        createSelector('shoppingCart', state => state.shoppingCart);

        registerEvent('addProductToCart', (state, message) => {
            let products = state.products.map(product =>
                Object.assign({}, product, { quantity: product.quantity - ((product.id == message.id) ? 1 : 0) })
            );

            let shoppingCart = [].slice.apply(state.shoppingCart);

            let index = shoppingCart.findIndex(product => product.id == message.id);

            if (index == -1) {
                shoppingCart.push(Object.assign({}, message, { quantity: 1 }));
            } else {
                shoppingCart[index].quantity += 1;
            }

            return { db: { shoppingCart, products } };
        });

        let Cart = ([ shoppingCart = [] ]) => {
            let productKindAmount = shoppingCart.length;
            let productsAmount = shoppingCart.reduce((acc, p) => acc + p.quantity, 0);
            let text = productKindAmount == productsAmount ? `Products in cart: ${productKindAmount}` : `Products in cart: ${productKindAmount} (${productsAmount})`;

            return
                c('div', [
                    c('div',
                        { class: 'shopping-cart' },
                        text
                    )
                ]);
        };

        let ProductList = ([ products = [] ]) => {
            products = products.map(product =>
                c('div', { class: 'product' }, [
                    c('div', { class: 'title' }, product.title),
                    c('div', { class: 'price' }, product.price),
                    c('div', { class: 'description' }, product.description),
                    c('div', { class: 'quantity' }, `Available: ${product.quantity}`),
                    c('div', { class: 'actions' }, [
                        c('button',
                            {
                                click: () => dispatch({ addProductToCart: product }),
                                disabled: product.quantity == 0 ? 'disabled' : undefined
                            },
                            'Add to cart'
                        )
                    ] ),
                ] )
            );

            return c('div', { class: 'product-list' }, products);
        };

        let App = ([ shoppingCart, products ]) =>
            c('div', [
                c(Cart, shoppingCart),
                c(ProductList, products)
            ]);

        connectToStore([ 'shoppingCart', 'products' ], App).mount(document.querySelector('#app'));
    </script>
</body>

</html>
